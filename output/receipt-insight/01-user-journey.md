# 用户旅程地图

## 主用户角色：日常消费者

```mermaid
journey
    title 用户使用「花在哪里了」的完整体验旅程
    section 发现与注册
      首次打开App: 5: 用户
      查看引导页: 4: 用户
      注册账户: 4: 用户
      登录成功: 5: 用户
    section 首次使用
      看到空状态引导: 4: 用户
      点击拍照按钮: 5: 用户
      选择拍照或相册: 5: 用户
      上传小票: 4: 用户
      等待AI识别: 3: 用户
      查看识别结果: 5: 用户
      阅读分析报告: 5: 用户
    section 持续使用
      查看小票列表: 4: 用户
      点击单张小票: 4: 用户
      浏览历史记录: 4: 用户
      批量上传多张: 4: 用户
      查看周/月报表: 5: 用户
    section 价值获得
      发现消费趋势: 5: 用户
      获得省钱建议: 5: 用户
      了解营养摄入: 5: 用户
```

> **图注**：用户旅程图展示了从发现产品到获得价值的主要阶段和关键触点。每个步骤的评分(1-5)反映了该环节的用户体验满意度。整体旅程流畅，核心痛点仅在"等待AI识别"环节略有等待。

---

## 用户决策流程

```mermaid
flowchart TD
    A[用户打开App] --> B{是否已登录?}
    B -->|否| C[显示登录页]
    C --> D[注册/登录]
    D --> E[进入首页]
    B -->|是| E
    
    E --> F{有小票记录?}
    F -->|否| G[显示引导页]
    G --> H[点击拍照按钮]
    F -->|是| I[显示小票列表]
    I --> J{用户操作?}
    
    J -->|点击拍照| H
    J -->|查看统计| K[进入统计页]
    J -->|点击小票| L[查看小票详情]
    
    H --> M{选择方式}
    M -->|拍照| N[调用相机]
    M -->|相册| O[选择照片]
    
    N --> P[上传图片]
    O --> P
    P --> Q[AI处理中...]
    Q --> R{是否重复?}
    R -->|是| S[提示已存在]
    R -->|否| T[显示结果+分析]
    
    T --> U{继续操作?}
    U -->|保存| V[存入列表]
    U -->|关闭| I
    
    K --> W{选择报表类型}
    W -->|周报| X[查看周报]
    W -->|月报| Y[查看月报]
    W -->|全部| Z[查看全部数据]
    
    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style V fill:#c8e6c9
    style S fill:#ffcdd2
```

> **图注**：决策树展示了用户在 App 中的所有可能操作路径。从打开 App 到完成一次记账，用户可能经历 4-8 个步骤，流程简洁清晰。核心分支在首页根据"是否有记录"展示不同内容。

---

## 关键操作的前后端交互

### 1. 单张小票识别流程

```mermaid
sequenceDiagram
    actor U as 用户
    participant F as App前端
    participant API as 后端API
    participant AI as Gemini AI
    participant DB as 数据库
    
    U->>F: 1. 点击"拍照"
    F->>F: 2. 调用摄像头/相册
    U->>F: 3. 确认照片
    F->>F: 4. 压缩图片
    
    F->>API: 5. POST /api/receipts/upload<br/>body: {imageData: base64}
    API->>DB: 6. 保存原始图片
    API-->>F: 7. 返回 {id, status: 'pending'}
    
    F->>F: 8. 本地显示"正在分析"
    
    F->>API: 9. POST /api/receipts/:id/process
    API->>DB: 10. 查询图片数据
    DB-->>API: 11. 返回图片数据
    
    API->>AI: 12. 调用OCR识别
    AI-->>API: 13. 返回结构化数据
    
    API->>DB: 14. 查询近3天消费记录
    DB-->>API: 15. 返回历史数据
    
    API->>AI: 16. 请求生成分析报告
    AI-->>API: 17. 返回分析文本
    
    API->>DB: 18. 保存完整数据
    API-->>F: 19. 返回完整receipt数据
    
    F->>F: 20. 更新本地状态
    F->>U: 21. 显示结果+分析弹窗
```

> **图注**：单张小票从拍照到展示结果涉及 21 个步骤，前后端 5 次通信，AI 2 次调用。整个过程约需 3-5 秒，用户体验流畅。关键优化点包括图片压缩减少传输时间、服务端OCR减轻客户端负担。

### 2. 批量处理流程

```mermaid
sequenceDiagram
    actor U as 用户
    participant F as App前端
    participant API as 后端API
    participant AI as Gemini AI
    participant DB as 数据库
    
    U->>F: 1. 从相册多选N张照片
    F->>F: 2. 批量压缩
    
    par 并行上传
        F->>API: upload #1
        F->>API: upload #2
        F->>API: upload #N
    end
    
    API-->>F: 3. 返回N个receipt ID
    F->>F: 4. 显示批量进度条
    
    loop 逐个处理
        F->>API: process receipt #1
        API->>AI: OCR识别
        AI-->>API: 结构化数据
        API->>DB: 保存结果
        API-->>F: 完成#1
        F->>F: 更新进度(1/N)
    end
    
    F->>U: 5. 全部完成提示
```

> **图注**：批量处理采用"并行上传 + 串行处理"策略。上传阶段并行可以充分利用带宽，处理阶段串行可以避免 AI API 限流。用户通过进度条实时了解处理状态。

### 3. 查看报表流程

```mermaid
sequenceDiagram
    actor U as 用户
    participant F as App前端
    participant API as 后端API
    participant DB as 数据库
    participant AI as Gemini AI
    
    U->>F: 1. 点击"统计"标签
    F->>API: 2. GET /api/reports/week
    API->>DB: 3. 查询已存报告
    DB-->>API: 4. 返回报告内容
    
    alt 报告存在
        API-->>F: 5. 返回已有报告
        F->>U: 6. 直接展示报告
    else 报告不存在
        API-->>F: 7. 返回空
        F->>API: 8. 请求生成新报告
        API->>DB: 9. 查询本周所有小票
        DB-->>API: 10. 返回消费数据
        API->>AI: 11. 请求生成周报
        AI-->>API: 12. 返回Markdown报告
        API->>DB: 13. 保存报告
        API-->>F: 14. 返回新报告
        F->>U: 15. 展示报告
    end
```

> **图注**：报表采用"缓存优先"策略。首次生成后保存到数据库，下次直接读取，避免重复调用 AI。用户可以手动刷新重新生成，适合查看实时数据。

---

## 用户情绪曲线

```mermaid
xychart-beta
    title "用户情绪值变化曲线"
    x-axis [打开App, 登录, 首次拍照, 等待识别, 看到结果, 阅读分析, 查看报表]
    y-axis "情绪值" 0 --> 10
    line [7, 6, 8, 5, 9, 9, 8]
```

**情绪节点解读：**

| 阶段 | 情绪值 | 原因 | 优化方向 |
|------|--------|------|---------|
| 打开App | 7 | 好奇心驱动，期待新体验 | - |
| 登录 | 6 | 注册/登录有一定门槛 | 支持游客模式 |
| 首次拍照 | 8 | 操作简单，符合直觉 | - |
| 等待识别 | 5 | 等待期间略焦虑 | 添加趣味动画 |
| 看到结果 | 9 | 识别准确，惊喜感 | - |
| 阅读分析 | 9 | 分析有价值，超出预期 | - |
| 查看报表 | 8 | 数据可视化，清晰易懂 | 增加更多图表 |

---

## 用户触点清单

```mermaid
flowchart LR
    subgraph 移动端["移动端触点"]
        A1[App图标]
        A2[启动页]
        A3[登录页]
        A4[首页-空状态]
        A5[首页-列表]
        A6[拍照按钮]
        A7[选择菜单]
        A8[扫描动画]
        A9[结果弹窗]
        A10[小票详情]
        A11[统计页]
        A12[报表视图]
        A13[个人中心]
    end
    
    subgraph 服务端["服务端触点"]
        B1[注册API]
        B2[登录API]
        B3[上传API]
        B4[处理API]
        B5[列表API]
        B6[报表API]
    end
    
    subgraph AI触点["AI触点"]
        C1[OCR识别]
        C2[消费分析]
        C3[报告生成]
    end
    
    A3 --> B1
    A3 --> B2
    A6 --> A7
    A7 --> B3
    B3 --> A8
    A8 --> B4
    B4 --> C1
    B4 --> C2
    B4 --> A9
    A5 --> B5
    A11 --> B6
    B6 --> C3
    C3 --> A12
```

> **图注**：触点地图展示了用户在使用产品过程中接触到的所有界面和功能点。移动端13个触点，服务端6个API，AI层3个能力。整体触点精简，没有冗余功能。

---

## 典型用户故事

### 故事一：上班族小张的一周记账

**周一** - *首次使用*

小张午休时在便利店买了便当，同事推荐了这个 App。他下载后打开，看到简洁的登录页，用邮箱快速注册。首页提示"还没有小票，拍一张吧"，他点击中间的拍照按钮，选择"拍照"，对准小票拍了一张。

App 显示扫描动画，3秒后弹出结果：识别出7-Eleven、¥32、照烧鸡肉饭+可乐。分析说"这顿热量偏高，建议搭配蔬菜"。小张觉得很有趣，点击保存。

**周三** - *持续使用*

小张已经养成了习惯，每天吃完午饭就拍一张。今天他看到小票列表里已经有3条记录了。点击周二那张，能看到详细的营养分析和省钱建议。

**周日** - *查看周报*

小张切换到统计页，点击查看周报。系统显示："本周午餐共花费¥186，平均¥37/餐。与上周相比增加12%，主要原因是周三那顿商务餐较贵。营养方面，本周蛋白质摄入充足，但膳食纤维偏低，建议多吃蔬菜。"

小张觉得很有价值，决定下周开始控制午餐预算在¥30以内。

---

### 故事二：宝妈王女士的批量记账

**周六早上** - *超市大采购*

王女士带孩子在超市采购，买了生鲜、日用品、零食，一共6张小票。以前她都是随手丢掉小票，现在有了这款 App，决定试试。

回家后，她打开 App，点击拍照按钮选择"从相册选择"，一次性选中了6张小票照片。App 显示批量进度条，开始逐个处理。

**处理过程**

第一张生鲜小票识别完成，显示"永辉超市、¥156、蔬菜肉类等"。分析说"本周生鲜采购充足，建议3天内吃完保持新鲜"。

第二张日用品小票识别完成...（过程类似）

**结果汇总**

6张小票全部处理完成（其中1张被标记为重复，因为上周同样日期也来买过）。App 自动生成了周报："本周超市采购¥486，其中食品占比65%、日用品25%、零食10%。发现零食开销比上月增加¥50，建议适当控制。"

王女士很满意，终于清楚家庭开支花在哪儿了。
